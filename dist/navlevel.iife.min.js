(function() {
  "use strict";
  try {
    if (typeof document != "undefined") {
      var elementStyle = document.createElement("style");
      elementStyle.appendChild(document.createTextNode(".navlevel-nav[data-v-61e76585] {\n    display: flex;\n    flex-direction: row;\n    flex-wrap: wrap;\n    gap: 2px 1em;\n}\n.navlevel-radio-group[data-v-61e76585] {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    flex-wrap: wrap;\n    padding: 2px;\n}"));
      document.head.appendChild(elementStyle);
    }
  } catch (e) {
    console.error("vite-plugin-css-injected-by-js", e);
  }
})();
(function(vue, codex) {
  "use strict";
  const KEY = "rswiki:NavLevel-data";
  const LEVEL_KEY = "rswiki:NavLevel-levels";
  const EXPIRY_KEY = "rswiki:NavLevel-expiry";
  const OPTIONS_KEY = "rswiki:NavLevel-options";
  const REJECT_THRESHOLD = 210;
  const EXPIRY_SECS = 3600 * 12;
  const EXPIRY_MS = EXPIRY_SECS * 1e3;
  const ORIGIN = "https://rs.miraheze.org/";
  async function fetchData() {
    const res = await new mw.Api().get({
      action: "cargoquery",
      formatversion: 2,
      tables: "Level",
      fields: "Level.name_zh = name, Level.num = num, Level._pageName = page, Level.type = type, Level.stars = stars, Level.first_came_version = inVer, Level.removed_version = remVer, Level.restored_version = resVer",
      where: "Level.stars IS NOT NULL AND(Level.type = '官方' OR Level.type = '共创') AND (Level.removed_version IS NULL OR Level.restored_version IS NOT NULL)",
      limit: 500
    });
    if (!res.cargoquery) {
      return null;
    }
    const data = res.cargoquery.map((item) => {
      return {
        ...item.title,
        num: Number(item.title.num),
        stars: Number(item.title.stars)
      };
    });
    if (data.length < REJECT_THRESHOLD) {
      return null;
    }
    return data;
  }
  async function getData() {
    const dataJson = localStorage.getItem(KEY);
    let data;
    try {
      if (!dataJson) {
        throw new Error("No data");
      }
      data = JSON.parse(dataJson);
    } catch (e) {
    }
    const expiry = localStorage.getItem(EXPIRY_KEY);
    if (expiry && Number(expiry) && Number(expiry) < Date.now()) {
      console.log("Expired, fetching new data");
      const newData = await fetchData();
      if (newData) {
        localStorage.setItem(KEY, JSON.stringify(newData));
        localStorage.setItem(EXPIRY_KEY, String(Date.now() + EXPIRY_MS));
        return newData;
      } else {
        return data;
      }
    }
    if (!data) {
      data = await fetchData();
      if (data) {
        localStorage.setItem(KEY, JSON.stringify(data));
        localStorage.setItem(EXPIRY_KEY, String(Date.now() + EXPIRY_MS));
      }
      return data;
    }
    return data;
  }
  async function getValidLevels() {
    let levels = mw.storage.getObject(LEVEL_KEY);
    if (levels) {
      return levels;
    }
    const res = await fetch(ORIGIN + "wiki/Module:NavLevel/levels?action=raw");
    if (!res.ok) {
      return null;
    }
    const text = await res.text();
    const intoJSON = text.replace(/^return\s+/, "").replace(/\{/g, "[").replace(/\}/g, "]").replace(/\-\-.*?\n/g, "");
    try {
      levels = JSON.parse(intoJSON);
    } catch (e) {
      return null;
    }
    mw.storage.setObject(LEVEL_KEY, levels, EXPIRY_SECS);
    return levels;
  }
  function saveOptionsToStorage(options) {
    mw.storage.setObject(OPTIONS_KEY, options);
  }
  function loadOptionsFromStorage() {
    const options = mw.storage.getObject(OPTIONS_KEY);
    if (!options) {
      return null;
    }
    return options;
  }
  const prodData = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({
    __proto__: null,
    fetchData,
    getData,
    getValidLevels,
    loadOptionsFromStorage,
    saveOptionsToStorage
  }, Symbol.toStringTag, { value: "Module" }));
  let convByVar;
  {
    ({ convByVar } = require("ext.gadget.HanAssist"));
  }
  const variantedLevelNames = /* @__PURE__ */ new Map();
  function collectLevelVariants(links) {
    for (const link of links) {
      const name = link.textContent.trim();
      const page = decodeURI(link.href.split("wiki/")[1]);
      variantedLevelNames.set(page, name);
      variantedLevelNames.set(name, name);
      variantedLevelNames.set(page.replace(/_/g, " "), name);
      variantedLevelNames.set(name.replace(/_/g, " "), name);
    }
  }
  function getVariantedLevelName(name) {
    return variantedLevelNames.get(name) || name;
  }
  function variantedType(type) {
    {
      return convByVar({ hans: "共创", hant: "共創" });
    }
  }
  const _hoisted_1$1 = { class: "hlist" };
  const _hoisted_2$1 = ["href", "title"];
  const _sfc_main$1 = /* @__PURE__ */ vue.defineComponent({
    __name: "HList",
    props: {
      levels: {}
    },
    setup(__props) {
      console.log(convByVar);
      function extractNameFromEntry(entry) {
        return getVariantedLevelName(entry.page);
      }
      return (_ctx, _cache) => {
        return vue.openBlock(), vue.createElementBlock("ul", _hoisted_1$1, [
          (vue.openBlock(true), vue.createElementBlock(vue.Fragment, null, vue.renderList(__props.levels, (level) => {
            return vue.openBlock(), vue.createElementBlock("li", null, [
              vue.createElementVNode("a", {
                href: `/wiki/${encodeURI(level.page)}`,
                title: `${level.type === "官方" ? "Lv." : "Co."}${level.num} ${extractNameFromEntry(level)} ${"★".repeat(level.stars)}`
              }, vue.toDisplayString(extractNameFromEntry(level)), 9, _hoisted_2$1)
            ]);
          }), 256))
        ]);
      };
    }
  });
  const _hoisted_1 = { class: "navbox-above navbox-cell navbox-sole-row" };
  const _hoisted_2 = { class: "navbox-above navbox-cell navbox-sole-row navlevel-nav" };
  const _hoisted_3 = { class: "navlevel-radio-group" };
  const _hoisted_4 = { class: "navlevel-radio-group" };
  const _hoisted_5 = { class: "navlevel-radio-group" };
  const _hoisted_6 = { class: "navlevel-radio-group" };
  const _hoisted_7 = {
    key: 0,
    class: "navbox-list navbox-sole-row"
  };
  const _hoisted_8 = { class: "navbox-group navbox-cell" };
  const _hoisted_9 = { class: "navbox-group-flex-inner" };
  const _hoisted_10 = { class: "navbox-list navbox-cell" };
  const _hoisted_11 = {
    key: 0,
    class: "navbox-group navbox-cell"
  };
  const _hoisted_12 = { class: "navbox-group-flex-inner" };
  const _hoisted_13 = {
    key: 1,
    class: "navbox navbox-list navbox-cell navbox-level-1 mobileplainbox"
  };
  const _hoisted_14 = {
    key: 0,
    class: "navbox-group navbox-cell"
  };
  const _hoisted_15 = { class: "navbox-group-flex-inner" };
  const _hoisted_16 = {
    key: 1,
    class: "navbox-list navbox-cell"
  };
  const _sfc_main = /* @__PURE__ */ vue.defineComponent({
    __name: "Main",
    props: {
      data: {},
      levels: {},
      preservedElements: {},
      titleElement: {}
    },
    setup(__props) {
      const dataModule = prodData;
      const { saveOptionsToStorage: saveOptionsToStorage2, loadOptionsFromStorage: loadOptionsFromStorage2 } = dataModule;
      const props = __props;
      const Grouping = {
        type: convByVar({ hans: "类型", hant: "類型" }),
        era: convByVar({ hans: "时期", hant: "時期" }),
        // status: , // 地位（传统意义上的主线、奖励）
        // year: "年份",
        stars: convByVar({ hans: "星数", hant: "星數" }),
        none: convByVar({ hans: "无", hant: "無" })
      };
      const Sorting = {
        num: convByVar({ hans: "编号", hant: "編號" }),
        name: convByVar({ hans: "名称", hant: "名稱" }),
        stars: convByVar({ hans: "星数", hant: "星數" }),
        default: convByVar({ hans: "默认", hant: "預設" })
      };
      const Direction = {
        asc: "升序",
        desc: "降序"
      };
      const options = loadOptionsFromStorage2();
      function isValidGrouping(value) {
        return value in Grouping;
      }
      function isValidSorting(value) {
        return value in Sorting;
      }
      function isValidDirection(value) {
        return value in Direction;
      }
      const grouping1 = vue.ref(
        options?.grouping1 && isValidGrouping(options.grouping1) ? options.grouping1 : "type"
      );
      const grouping2 = vue.ref(
        options?.grouping2 && isValidGrouping(options.grouping2) ? options.grouping2 : "stars"
      );
      const sorting = vue.ref(
        options?.sorting && isValidSorting(options.sorting) ? options.sorting : "default"
      );
      const direction = vue.ref(
        options?.direction && isValidDirection(options.direction) ? options.direction : "asc"
      );
      const mark = vue.ref(null);
      const markerBefore = vue.ref(null);
      const displayData = vue.ref({});
      vue.onMounted(() => {
        if (markerBefore.value && props.preservedElements?.length) {
          const preserveBeforeElements = props.preservedElements.filter(
            (element) => element.classList.contains("navlevel-sortable-preserve-before")
          );
          const preserveElements = props.preservedElements.filter(
            (element) => element.classList.contains("navlevel-sortable-preserve")
          );
          let referenceNode = markerBefore.value;
          preserveBeforeElements.forEach((element) => {
            if (element && referenceNode.parentNode) {
              referenceNode.parentNode.insertBefore(element, referenceNode);
              referenceNode = element;
            }
          });
          referenceNode = mark.value;
          preserveElements.forEach((element) => {
            if (element && referenceNode && referenceNode.parentNode) {
              referenceNode.parentNode.insertBefore(element, referenceNode.nextSibling);
              referenceNode = element;
            }
          });
          if (mark.value) {
            mark.value.remove();
          }
          if (markerBefore.value) {
            markerBefore.value.remove();
          }
        }
        sort();
      });
      function rawCompare(a, b) {
        switch (sorting.value) {
          case "num":
            return a.type === b.type ? a.num - b.num : a.type === "官方" ? -1 : 1;
          case "name":
            return a.name.localeCompare(b.name);
          case "stars":
            return a.stars - b.stars || props.levels.indexOf(a.page) - props.levels.indexOf(b.page);
          case "default":
            return props.levels.indexOf(a.page) - props.levels.indexOf(b.page);
          default:
            return 0;
        }
      }
      function compare(a, b) {
        return direction.value === "asc" ? rawCompare(a, b) : rawCompare(b, a);
      }
      function rawgroup(entries, grouping) {
        switch (grouping) {
          case "era":
            return [
              {
                group: "辣椒",
                list: entries.filter(
                  (entry) => entry.type === "官方" && entry.num <= 7
                )
                // 俄方（8）
              },
              {
                group: convByVar({ hans: "猎豹", hant: "獵豹" }),
                list: entries.filter(
                  (entry) => entry.type === "官方" && entry.num > 7 && entry.num <= 94
                )
              },
              {
                group: convByVar({ hans: "米麦", hant: "米麥" }),
                list: entries.filter(
                  (entry) => entry.type === "共创" || entry.type === "官方" && entry.num > 94
                )
              }
            ];
          case "type":
            const groups = [];
            groups.push({
              group: "官方",
              list: entries.filter((entry) => entry.type === "官方")
            });
            groups.push({
              group: variantedType(),
              list: entries.filter((entry) => entry.type === "共创")
            });
            return groups;
          case "stars":
            const seenStars = /* @__PURE__ */ new Set();
            entries.forEach((entry) => seenStars.add(entry.stars));
            const stars = Array.from(seenStars).sort((a, b) => a - b);
            return stars.map((star) => {
              return {
                group: star + " 星",
                list: entries.filter((entry) => entry.stars === star)
              };
            });
          // case Grouping.status:
          default:
            return entries;
        }
      }
      function group(entries, grouping) {
        return rawgroup(entries, grouping).map((g) => {
          g.list = g.list.sort(compare);
          return g;
        });
      }
      function sort() {
        if (grouping1.value === grouping2.value && grouping2.value !== "none") {
          grouping2.value = grouping1.value === "stars" ? "type" : "stars";
        }
        if (grouping1.value === "none") {
          grouping2.value = "none";
        }
        saveOptionsToStorage2({
          grouping1: grouping1.value,
          grouping2: grouping2.value,
          sorting: sorting.value,
          direction: direction.value
        });
        if (grouping1.value === "none") {
          displayData.value = [...props.data].sort(compare);
          return;
        } else if (grouping2.value === "none") {
          displayData.value = group(props.data, grouping1.value);
          console.log(displayData.value);
        } else {
          displayData.value = group(props.data, grouping1.value).map((g) => {
            g.list = group(g.list, grouping2.value);
            return g;
          });
          console.log(displayData.value);
        }
      }
      return (_ctx, _cache) => {
        return vue.openBlock(), vue.createElementBlock(vue.Fragment, null, [
          vue.createElementVNode("div", {
            ref_key: "markerBefore",
            ref: markerBefore
          }, null, 512),
          vue.createElementVNode("div", _hoisted_1, vue.toDisplayString(vue.unref(convByVar)({
            hans: `本智能排序为实验性功能。当前获取到 ${__props.data.length} 个关卡的数据。`,
            hant: `本智能排序為實驗性功能。當前獲取到 ${__props.data.length} 個關卡的數據。`
          })), 1),
          vue.createElementVNode("div", _hoisted_2, [
            vue.createElementVNode("div", _hoisted_3, [
              vue.createTextVNode(vue.toDisplayString(vue.unref(convByVar)({ hans: "一级分组：", hant: "一級分組：" })) + " ", 1),
              (vue.openBlock(), vue.createElementBlock(vue.Fragment, null, vue.renderList(Grouping, (_, key) => {
                return vue.createVNode(vue.unref(codex.CdxRadio), {
                  "model-value": grouping1.value,
                  "onUpdate:modelValue": [
                    _cache[0] || (_cache[0] = ($event) => grouping1.value = $event),
                    sort
                  ],
                  "input-value": key,
                  name: "grouping1",
                  inline: true
                }, {
                  default: vue.withCtx(() => [
                    vue.createTextVNode(vue.toDisplayString(Grouping[key]), 1)
                  ]),
                  _: 2
                }, 1032, ["model-value", "input-value"]);
              }), 64))
            ]),
            vue.createElementVNode("div", _hoisted_4, [
              vue.createTextVNode(vue.toDisplayString(vue.unref(convByVar)({ hans: "二级分组：", hant: "二級分組：" })) + " ", 1),
              (vue.openBlock(), vue.createElementBlock(vue.Fragment, null, vue.renderList(Grouping, (_, key) => {
                return vue.createVNode(vue.unref(codex.CdxRadio), {
                  "model-value": grouping2.value,
                  "onUpdate:modelValue": [
                    _cache[1] || (_cache[1] = ($event) => grouping2.value = $event),
                    sort
                  ],
                  "input-value": key,
                  name: "grouping2",
                  inline: true,
                  disabled: key !== grouping1.value === (grouping1.value === "none")
                }, {
                  default: vue.withCtx(() => [
                    vue.createTextVNode(vue.toDisplayString(Grouping[key]), 1)
                  ]),
                  _: 2
                }, 1032, ["model-value", "input-value", "disabled"]);
              }), 64))
            ]),
            vue.createElementVNode("div", _hoisted_5, [
              _cache[4] || (_cache[4] = vue.createTextVNode(" 排序： ", -1)),
              (vue.openBlock(), vue.createElementBlock(vue.Fragment, null, vue.renderList(Sorting, (_, key) => {
                return vue.createVNode(vue.unref(codex.CdxRadio), {
                  key,
                  name: "sorting",
                  "input-value": key,
                  "model-value": sorting.value,
                  "onUpdate:modelValue": [
                    _cache[2] || (_cache[2] = ($event) => sorting.value = $event),
                    sort
                  ],
                  inline: true
                }, {
                  default: vue.withCtx(() => [
                    vue.createTextVNode(vue.toDisplayString(Sorting[key]), 1)
                  ]),
                  _: 2
                }, 1032, ["input-value", "model-value"]);
              }), 64))
            ]),
            vue.createElementVNode("div", _hoisted_6, [
              (vue.openBlock(), vue.createElementBlock(vue.Fragment, null, vue.renderList(Direction, (_, key) => {
                return vue.createVNode(vue.unref(codex.CdxRadio), {
                  name: "direction",
                  "input-value": key,
                  "model-value": direction.value,
                  "onUpdate:modelValue": [
                    _cache[3] || (_cache[3] = ($event) => direction.value = $event),
                    sort
                  ],
                  inline: true
                }, {
                  default: vue.withCtx(() => [
                    vue.createTextVNode(vue.toDisplayString(Direction[key]), 1)
                  ]),
                  _: 2
                }, 1032, ["input-value", "model-value"]);
              }), 64))
            ])
          ]),
          grouping1.value === "none" ? (vue.openBlock(), vue.createElementBlock("div", _hoisted_7, [
            vue.createVNode(_sfc_main$1, { levels: displayData.value }, null, 8, ["levels"])
          ])) : (vue.openBlock(), vue.createElementBlock(vue.Fragment, { key: 1 }, [
            grouping2.value === "none" ? (vue.openBlock(true), vue.createElementBlock(vue.Fragment, { key: 0 }, vue.renderList(displayData.value, (group2) => {
              return vue.openBlock(), vue.createElementBlock(vue.Fragment, null, [
                vue.createElementVNode("div", _hoisted_8, [
                  vue.createElementVNode("span", _hoisted_9, vue.toDisplayString(group2.group), 1)
                ]),
                vue.createElementVNode("div", _hoisted_10, [
                  vue.createVNode(_sfc_main$1, {
                    levels: group2.list
                  }, null, 8, ["levels"])
                ])
              ], 64);
            }), 256)) : (vue.openBlock(true), vue.createElementBlock(vue.Fragment, { key: 1 }, vue.renderList(displayData.value, (group2) => {
              return vue.openBlock(), vue.createElementBlock(vue.Fragment, null, [
                group2.list.length > 0 ? (vue.openBlock(), vue.createElementBlock("div", _hoisted_11, [
                  vue.createElementVNode("span", _hoisted_12, vue.toDisplayString(group2.group), 1)
                ])) : vue.createCommentVNode("", true),
                group2.list.length > 0 ? (vue.openBlock(), vue.createElementBlock("div", _hoisted_13, [
                  (vue.openBlock(true), vue.createElementBlock(vue.Fragment, null, vue.renderList(group2.list, (subgroup) => {
                    return vue.openBlock(), vue.createElementBlock(vue.Fragment, null, [
                      subgroup.list.length > 0 ? (vue.openBlock(), vue.createElementBlock("div", _hoisted_14, [
                        vue.createElementVNode("span", _hoisted_15, vue.toDisplayString(subgroup.group), 1)
                      ])) : vue.createCommentVNode("", true),
                      subgroup.list.length > 0 ? (vue.openBlock(), vue.createElementBlock("div", _hoisted_16, [
                        vue.createVNode(_sfc_main$1, {
                          levels: subgroup.list
                        }, null, 8, ["levels"])
                      ])) : vue.createCommentVNode("", true)
                    ], 64);
                  }), 256))
                ])) : vue.createCommentVNode("", true)
              ], 64);
            }), 256))
          ], 64)),
          vue.createElementVNode("div", {
            ref_key: "mark",
            ref: mark
          }, null, 512)
        ], 64);
      };
    }
  });
  const _export_sfc = (sfc, props) => {
    const target = sfc.__vccOpts || sfc;
    for (const [key, val] of props) {
      target[key] = val;
    }
    return target;
  };
  const Nav = /* @__PURE__ */ _export_sfc(_sfc_main, [["__scopeId", "data-v-61e76585"]]);
  async function initNavLevel() {
    const dataModule = prodData;
    const { getData: getData2, getValidLevels: getValidLevels2 } = dataModule;
    try {
      const [data, levels] = await Promise.all([
        getData2(),
        getValidLevels2()
      ]);
      if (!data || !levels) {
        mw.notify("Failed to fetch qualified data", { type: "error" });
        return;
      }
      const navboxes = document.querySelectorAll(".navlevel-sortable");
      $.each(navboxes, async (_, navbox) => {
        collectLevelVariants(Array.from(navbox.querySelectorAll("a[href]")));
        const preservedElements = Array.from(navbox.querySelectorAll(".navlevel-sortable-preserve, .navlevel-sortable-preserve-before"));
        preservedElements.forEach((element) => {
          if (element.parentNode) {
            element.parentNode.removeChild(element);
          }
        });
        const $navbox = $(navbox);
        $navbox.empty();
        const app = Vue.createApp(Nav, {
          data,
          levels,
          preservedElements,
          titleElement: navbox.querySelector(".navbox-title") || document.createElement("div")
        });
        app.mount(navbox);
      });
    } catch (error) {
      console.error("Failed to initialize NavLevel:", error);
      mw.notify("Failed to initialize NavLevel: " + error.message, { type: "error" });
    }
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initNavLevel);
  } else {
    initNavLevel();
  }
})(Vue, Codex);
